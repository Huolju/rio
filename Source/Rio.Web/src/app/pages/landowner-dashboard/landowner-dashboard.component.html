<div class="container mt-sm-4" *ngIf="user">
  <div class="float-right">
    <div class="row">
      <div class="col-md-7" style="white-space: nowrap">Showing data for year </div>
      <div class="col-md-5">
        <select class="form-control" [(ngModel)]="waterYearToDisplay">
          <ng-template ngFor let-waterYear [ngForOf]="waterYears">
            <option value="{{waterYear}}">{{waterYear}}</option>
          </ng-template>
        </select>
      </div>
    </div>
  </div>
  <h2>
    Landowner Dashboard - {{user.FullName}}
  </h2>
  <app-alert-display></app-alert-display>

  <div class="mt-2">
    <div class="alert alert-info" style="max-height: 160px; overflow: auto;" *ngIf="getPendingTrades().length > 0">
      <ul class="m-0 p-0">
        <li *ngFor="let pendingTrade of getPendingTrades()" style="list-style: circle">
          <span *ngIf="doesMostRecentOfferBelongToCurrentUser(pendingTrade)">
            {{getOfferThatBelongsToYouNotificationText(pendingTrade)}}
            <a class="small" routerLink="/trades/{{pendingTrade.TradeID}}">[View offer details]</a>
          </span>
          <span *ngIf="!doesMostRecentOfferBelongToCurrentUser(pendingTrade)">
            {{getOfferThatDoesNotBelongToYouNotificationText(pendingTrade)}}
            <a class="small" routerLink="/trades/{{pendingTrade.TradeID}}">[Respond to this offer]</a>
          </span>
        </li>
      </ul>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-sm-12 col-md-4" *ngIf="parcels && parcels.length > 0">
      <div class="card">
        <div class="card-header">
          Annual Water Budget Overview
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="text-sm-right col-sm-6 col-xs-12">Allocation</dt>
            <dd class="col-sm-6 col-xs-12">
              <span *ngIf="getAnnualAllocation()">{{getAnnualAllocation() | number: '1.1-1'}} ac-ft</span>
              <span *ngIf="!getAnnualAllocation()" class="systemText">Not available</span>
            </dd>

            <dt class="text-sm-right col-sm-6 col-xs-12">
              <a style="cursor: pointer; font-weight: normal" class="collapsed"
                (click)="showPurchasedDetails = !showPurchasedDetails"
                *ngIf="getPurchasedWaterTransfersForWaterYear().length > 0">
                <span *ngIf="!showPurchasedDetails" class="fas fa-plus"></span>
                <span *ngIf="showPurchasedDetails" class="fas fa-minus"></span>
              </a>
              Purchased
            </dt>
            <dd class="col-sm-6 col-xs-12">
              <span *ngIf="getPurchasedAcreFeet()">{{getPurchasedAcreFeet() | number: '1.1-1'}} ac-ft</span>
              <span *ngIf="!getPurchasedAcreFeet()" class="systemText">-</span>
            </dd>

            <ng-template ngFor let-waterTransfer [ngForOf]="getPurchasedWaterTransfersForWaterYear()"
              *ngIf="showPurchasedDetails">
              <dd class="text-sm-right col-sm-6 col-xs-12"><span
                  *ngIf="isWaterTransferPending(waterTransfer)">*</span>{{waterTransfer.TransferDate | date:"MM/dd"}}
              </dd>
              <dd class="col-sm-6 col-xs-12">{{waterTransfer.AcreFeetTransferred | number: '1.1-1'}} ac-ft</dd>
            </ng-template>

            <dt class="text-sm-right col-sm-6 col-xs-12">
              <a style="cursor: pointer" class="collapsed" (click)="showSoldDetails = !showSoldDetails"
                *ngIf="getSoldWaterTransfersForWaterYear().length > 0">
                <span *ngIf="!showSoldDetails" class="fas fa-plus"></span>
                <span *ngIf="showSoldDetails" class="fas fa-minus"></span>
              </a>
              Sold
            </dt>
            <dd class="col-sm-6 col-xs-12">
              <span *ngIf="getSoldAcreFeet()">{{getSoldAcreFeet() | number: '1.1-1'}} ac-ft</span>
              <span *ngIf="!getSoldAcreFeet()" class="systemText">-</span>
            </dd>

            <ng-template ngFor let-waterTransfer [ngForOf]="getSoldWaterTransfersForWaterYear()"
              *ngIf="showSoldDetails">
              <dd class="text-sm-right col-sm-6 col-xs-12"><span
                  *ngIf="isWaterTransferPending(waterTransfer)">*</span>{{waterTransfer.TransferDate | date:"MM/dd"}}
              </dd>
              <dd class="col-sm-6 col-xs-12">{{waterTransfer.AcreFeetTransferred | number: '1.1-1'}} ac-ft</dd>
            </ng-template>
          </dl>
          <p class="systemText" *ngIf="showSoldDetails || showPurchasedDetails">* denotes a pending transaction</p>
          <hr />
          <dl class="row">
            <dt class="text-sm-right col-sm-6 col-xs-12">
              Usage to Date
            </dt>
            <dd class="col-sm-6 col-xs-12">
              <span *ngIf="getWaterUsageToDate()">{{getWaterUsageToDate() | number: '1.1-1'}} ac-ft</span>
              <span *ngIf="!getWaterUsageToDate()" class="systemText">Not available</span>
            </dd>

            <dt class="text-sm-right col-sm-6 col-xs-12">Projected Need</dt>
            <dd class="col-sm-6 col-xs-12">
              <span class="systemText">Coming soon</span>
            </dd>
          </dl>
          <hr />
          <dl class="row">
            <dt class="text-sm-right col-sm-6 col-xs-12">Surplus / Deficit</dt>
            <dd class="col-sm-6 col-xs-12">
              <span class="systemText">Coming soon</span>
            </dd>
          </dl>
        </div>
      </div>
    </div>
    <div class="col-sm-12 col-md-8" *ngIf="trades">
      <div class="card">
        <div class="card-header">
          <div class="float-right">
            <label class="switch">
              <input type="checkbox" (change)="toggleTradeStatusShown()" />
              <div class="slider round">
                <span class="off">Open</span>
                <span class="on">All</span>
              </div>
            </label>
          </div>
          Trade Activity
        </div>
        <div class="card-body table-responsive" style="max-height: 300px; overflow-y:scroll">
          <p *ngIf="getTradesForWaterYear().length === 0">{{getNoTradesMessage()}}</p>
          <table class="table table-condensed table-striped" *ngIf="getTradesForWaterYear().length > 0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Status</th>
                <th>Description</th>
                <th style="text-align: right">Price</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let trade of getTradesForWaterYear()">
                <td style="border: 0 none"><a
                    routerLink="/trades/{{trade.TradeID}}">{{ trade.OfferDate | date:"short" }}</a></td>
                <td style="border: 0 none; white-space: nowrap">
                  <a routerLink="/confirm-transfer/{{trade.WaterTransferID}}" *ngIf="trade.WaterTransferID && !trade.IsConfirmed">Awaiting Payment Confirmation</a>
                  <span *ngIf="!trade.WaterTransferID || trade.IsConfirmed">{{getTradeStatus(trade)}}</span></td>
                <td style="border: 0 none">{{getTradeDescription(trade)}}</td>
                <td style="border: 0 none; white-space: nowrap; text-align: right">
                  {{ trade.Price * trade.Quantity | currency: "USD" }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card mt-2">
        <div class="card-header">
          <div class="float-right">
            <label class="switch">
              <input type="checkbox" (change)="togglePostingStatusShown()" />
              <div class="slider round">
                <span class="off">Open</span>
                <span class="on">All</span>
              </div>
            </label>
          </div>
          Postings
        </div>
        <div class="card-body table-responsive" style="max-height: 200px; overflow-y:scroll">
          <p *ngIf="getPostingsForWaterYear().length === 0">{{getNoPostingsMessage()}}</p>
          <table class="table table-condensed table-striped" *ngIf="getPostingsForWaterYear().length > 0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Status</th>
                <th>Initial Quantity</th>
                <th>Current Quantity</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let posting of getPostingsForWaterYear()">
                <td style="white-space: nowrap"><a
                    routerLink="/postings/{{posting.PostingID}}">{{ posting.PostingDate | date:"MM/dd" }}</a>
                </td>
                <td style="white-space: nowrap">{{ posting.PostingType.PostingTypeDisplayName }}
                </td>
                <td style="white-space: nowrap">{{ posting.PostingStatus.PostingStatusDisplayName }}
                </td>
                <td>{{ posting.Quantity }} ac-ft</td>
                <td>{{ posting.AvailableQuantity }} ac-ft</td>
                <td style="white-space: nowrap">{{ posting.Price | currency: "USD" }} per ac-ft</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-4">
    <div class="col-sm-12 col-md-12" *ngIf="parcels && parcels.length > 0">
      <div class="card mt-4">
        <div class="card-header">
          {{waterYearToDisplay}} Monthly Water Use, Volume (AF)
        </div>
        <div class="card-body">
          <rio-landowner-water-use-chart [waterUsageData]="getWaterUsageForWaterYear()" [parcelNumbers]="parcelNumbers"></rio-landowner-water-use-chart>

          <p class="small" *ngIf="parcels && parcels.length > 0">
            *Estimated water usage is based on satellite imagery and may not be accurate at the APN level.
          </p>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-4">
    <div class="col-sm-12 col-md-12" *ngIf="parcels">
      <div class="card mt-4" *ngIf="parcels && parcels.length > 0">
        <div class="card-header">
          Parcel Map
        </div>
        <div class="card-body">
          <parcel-map mapID="parcelsMapForUser" [selectedParcelIDs]="getSelectedParcelIDs()" mapHeight="500px">
          </parcel-map>
        </div>
      </div>
    </div>
  </div>
</div>