<div class="container mt-sm-4" *ngIf="user">
  <div class="float-right">
    <div class="row">
      <div class="col-md-7" style="white-space: nowrap">Showing data for year </div>
      <div class="col-md-5">
        <select class="form-control" [(ngModel)]="waterYearToDisplay">
          <ng-template ngFor let-waterYear [ngForOf]="waterYears">
            <option value="{{waterYear}}">{{waterYear}}</option>
          </ng-template>
        </select>
      </div>
    </div>
  </div>
  <h2>
    Landowner Dashboard - {{user.FullName}}
  </h2>
  <app-alert-display></app-alert-display>

  <div class="row mt-4">
    <div class="col-sm-12 col-md-4" *ngIf="parcels && parcels.length > 0">
      <div class="card">
        <div class="card-header">
          Annual Water Budget Overview
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-borderless">
              <tr>
                <th class="text-sm-left pb-0 mb-0" colspan="2">
                  <a style="cursor: pointer" class="collapsed small"
                    (click)="showAllocationDetails = !showAllocationDetails">
                    <span *ngIf="showAllocationDetails else dontShowAllocationDetails"
                      class="fas fa-minus text-muted"></span>
                    <ng-template #dontShowAllocationDetails>
                      <span class="fas fa-plus text-muted"></span>
                    </ng-template>
                  </a>
                  Allocation
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  {{getAnnualAllocation(waterYearToDisplay) | number: '1.1-1'}} ac-ft
                </td>
              </tr>
              <ng-container *ngIf="showAllocationDetails">
                <tr>
                  <td colspan="3">
                    <hr class="p-0 m-0" />
                  </td>
                </tr>
                <tr>
                  <th class="text-right">
                    Native Yield
                  </th>
                  <td colspan="2" class="text-sm-right">
                    {{getAnnualNativeYield() | number: '1.1-1'}} ac-ft
                  </td>
                </tr>
                <tr>
                  <th class="text-right">
                    Project Water
                  </th>
                  <td colspan="2" class="text-sm-right">
                    {{getAnnualProjectWater() | number: '1.1-1'}} ac-ft
                  </td>
                </tr>
                <tr>
                  <th class="text-right">
                    Stored Water
                  </th>
                  <td colspan="2" class="text-sm-right">
                    {{getAnnualStoredWater() | number: '1.1-1'}} ac-ft
                  </td>
                </tr>
                <tr>
                  <th class="text-right">
                    Reconciliation
                  </th>
                  <td colspan="2" class="text-sm-right">
                    {{getAnnualReconciliation() | number: '1.1-1'}} ac-ft
                  </td>
                </tr>
              </ng-container>
              <tr>
                <td colspan="3" class="text-left pt-0 mt-0">
                  <small>Your annual allocated water budget</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0" colspan="2">
                  <a style="cursor: pointer" class="collapsed small"
                    (click)="showPurchasedDetails = !showPurchasedDetails"
                    *ngIf="getPurchasedWaterTransfersForWaterYear().length > 0">
                    <span *ngIf="showPurchasedDetails else dontShowPurchasedDetails"
                      class="fas fa-minus text-muted"></span>
                    <ng-template #dontShowPurchasedDetails>
                      <span class="fas fa-plus text-muted"></span>
                    </ng-template>
                  </a>
                  Purchased
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  <span *ngIf="getPurchasedAcreFeet() as purchasedAcreFeet else noPurchasedAcreFeet">
                    {{purchasedAcreFeet | number: '1.1-1'}} ac-ft
                  </span>
                  <ng-template #noPurchasedAcreFeet>
                    <span class="systemText">-</span>
                  </ng-template>
                </td>
              </tr>
              <ng-container *ngIf="showPurchasedDetails">
                <tr>
                  <td colspan="3">
                    <hr class="p-0 m-0" />
                  </td>
                </tr>
                <tr *ngFor="let waterTransfer of getPurchasedWaterTransfersForWaterYear()">
                  <th class="text-sm-right"><span *ngIf="isWaterTransferPending(waterTransfer)">*</span><a
                      routerLink="/trades/{{waterTransfer.TradeNumber}}">{{waterTransfer.TradeNumber}}</a>
                  </th>
                  <td class="text-sm-right">{{waterTransfer.TransferDate | date:"MM/dd"}}</td>
                  <td class="text-sm-right">{{waterTransfer.AcreFeetTransferred | number: '1.1-1'}} ac-ft
                  </td>
                </tr>
              </ng-container>
              <tr>
                <td colspan="3" class="text-left pt-0 mt-0">
                  <small>Water supply you have purchased this year</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0" colspan="2">
                  <a style="cursor: pointer" class="collapsed small" (click)="showSoldDetails = !showSoldDetails"
                    *ngIf="getSoldWaterTransfersForWaterYear().length > 0">
                    <span *ngIf="showSoldDetails else dontShowSoldDetails" class="fas fa-minus text-muted"></span>
                    <ng-template #dontShowSoldDetails>
                      <span class="fas fa-plus text-muted"></span>
                    </ng-template>
                  </a>
                  Sold
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  <span *ngIf="getSoldAcreFeet() as soldAcreFeet else noSoldAcreFeet">
                    {{soldAcreFeet | number: '1.1-1'}} ac-ft
                  </span>
                  <ng-template #noSoldAcreFeet>
                    <span class="systemText">-</span>
                  </ng-template>
                </td>
              </tr>
              <ng-container *ngIf="showSoldDetails">
                <tr>
                  <td colspan="3">
                    <hr class="p-0 m-0" />
                  </td>
                </tr>
                <tr *ngFor="let waterTransfer of getSoldWaterTransfersForWaterYear()">
                  <th class="text-sm-right"><span *ngIf="isWaterTransferPending(waterTransfer)">*</span><a
                      routerLink="/trades/{{waterTransfer.TradeNumber}}">{{waterTransfer.TradeNumber}}</a>
                  </th>
                  <td class="text-sm-right">{{waterTransfer.TransferDate | date:"MM/dd"}}</td>
                  <td class="text-sm-right">{{waterTransfer.AcreFeetTransferred | number: '1.1-1'}} ac-ft
                  </td>
                </tr>
              </ng-container>
              <tr>
                <td colspan="3" class="text-left pt-0 mt-0">
                  <small>Water supply you have sold this year</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0" colspan="2">
                  Total Supply
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  <span>{{getTotalSupply() | number: '1.1-1'}} ac-ft</span>
                </td>
              </tr>
              <tr>
                <td colspan="3" class="text-left pt-0 mt-0">
                  <small>Allocation + Purchased – Sold</small>
                </td>
              </tr>
              <tr>
                <td colspan="3">
                  <small class="systemText" *ngIf="showSoldDetails || showPurchasedDetails">* denotes a pending
                    transaction</small>
                </td>
              </tr>
              <tr>
                <td colspan="3">
                  <hr />
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0" colspan="2">
                  Usage to Date
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  <span *ngIf="getWaterUsageToDate() as waterUsageToDate else noWaterUsage">
                    {{waterUsageToDate | number: '1.1-1'}} ac-ft
                  </span>
                  <ng-template #noWaterUsage>
                    <span class="systemText">Not available</span>
                  </ng-template>
                </td>
              </tr>
              <tr>
                <td colspan="3" class="text-left pt-0 mt-0">
                  <small>Total usage this year as measured by OpenET</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0" colspan="2">Current Available</th>
                <td class="text-sm-right pb-0 mb-0">
                  {{getCurrentAvailableWater() | number: '1.1-1'}} ac-ft
                </td>
              </tr>
              <tr>
                <td colspan="3" class="text-left pt-0 mt-0">
                  <small>Allocation + Purchased – Sold – Usage to Date</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0" colspan="2">Average Usage</th>
                <td class="text-sm-right pb-0 mb-0">
                  {{historicAverageAnnualUsage}} ac-ft
                </td>
              </tr>
              <tr>
                <td colspan="3" class="text-left pt-0 mt-0">
                  <small>Average usage from all years of OpenET data</small>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-12 col-md-8" *ngIf="trades">
      <div class="card">
        <div class="card-header">
          <div class="float-right">
            <label class="switch">
              <input type="checkbox" (change)="toggleTradeStatusShown()" />
              <div class="slider round">
                <span class="off">Active</span>
                <span class="on">All</span>
              </div>
            </label>
          </div>
          Trade Activity
        </div>
        <div class="card-body table-responsive" style="max-height: 300px; overflow-y:scroll">
          <ng-template #noTradesForWaterYear>
            <p>{{getNoTradesMessage()}}</p>
          </ng-template>
          <table class="table table-condensed table-striped"
            *ngIf="getTradesForWaterYear().length > 0 else noTradesForWaterYear">
            <thead>
              <tr>
                <th>Trade</th>
                <th>Date</th>
                <th>Status</th>
                <th>Description</th>
                <th style="text-align: right">Price</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let trade of getTradesForWaterYear()">
                <td style="border: 0 none; white-space: nowrap"><a
                    routerLink="/trades/{{trade.TradeNumber}}">{{ trade.TradeNumber }}</a></td>
                <td style="border: 0 none">{{ trade.OfferDate | date: "MM/dd" }}</td>
                <td style="border: 0 none; white-space: nowrap">
                  <a routerLink="/register-transfer/{{trade.WaterTransferID}}"
                    *ngIf="trade.WaterTransferID && !isTradeRegisteredByUser(trade) && !isTradeCanceled(trade)">
                    Awaiting Registration
                  </a>
                  <span *ngIf="trade.WaterTransferID && isTradeCanceled(trade)">Canceled</span>
                  <span
                    *ngIf="trade.WaterTransferID && isTradeRegisteredByUser(trade) && !isTradeRegisteredByBothParties(trade)">You
                    have already registered this transfer.<br />The other party must still register<br />before the
                    water
                    is transferred</span>
                  <span
                    *ngIf="!trade.WaterTransferID || isTradeRegisteredByBothParties(trade)">{{getTradeStatus(trade)}}</span>
                </td>
                <td style="border: 0 none">{{getTradeDescription(trade)}}</td>
                <td style="border: 0 none; white-space: nowrap; text-align: right">
                  {{ trade.Price * trade.Quantity | currency: "USD" }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card mt-2">
        <div class="card-header">
          <div class="float-right">
            <label class="switch">
              <input type="checkbox" (change)="togglePostingStatusShown()" />
              <div class="slider round">
                <span class="off">Active</span>
                <span class="on">All</span>
              </div>
            </label>
          </div>
          Postings
        </div>
        <div class="card-body table-responsive" style="max-height: 200px; overflow-y:scroll">
          <ng-template #noPostingsForWaterYear>
            <p>{{getNoPostingsMessage()}}</p>
          </ng-template>
          <table class="table table-condensed table-striped"
            *ngIf="getPostingsForWaterYear().length > 0 else noPostingsForWaterYear">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Status</th>
                <th>Initial Quantity</th>
                <th>Current Quantity</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let posting of getPostingsForWaterYear()">
                <td style="white-space: nowrap"><a
                    routerLink="/postings/{{posting.PostingID}}">{{ posting.PostingDate | date:"MM/dd" }}</a>
                </td>
                <td style="white-space: nowrap">{{ posting.PostingType.PostingTypeDisplayName }}
                </td>
                <td style="white-space: nowrap">{{ posting.PostingStatus.PostingStatusDisplayName }}
                </td>
                <td>{{ posting.Quantity | number: "1.0" }} ac-ft</td>
                <td>{{ posting.AvailableQuantity | number: "1.0" }} ac-ft</td>
                <td style="white-space: nowrap">{{ posting.Price | currency: "USD" }} per ac-ft</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <ng-template [ngIf]="parcels && parcels.length > 0">
    <div class="row mt-4">
      <div class="col-sm-12 col-md-12">
        <div class="card">
          <div class="card-header">
            {{waterYearToDisplay}} Allocation and Usage
          </div>
          <div class="card-body">
            <rio-landowner-water-allocation-chart [annualAllocationSeries]="getAnnualAllocationSeries()"
              [yDomain]="allocationChartRange" [historicCumulativeWaterUsage]="historicCumulativeWaterUsage"
              [currentCumulativeWaterUsage]="getCumulativeWaterUsageForWaterYear()">
            </rio-landowner-water-allocation-chart>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-4">
      <div class="col-sm-12 col-md-12">
        <div class="card">
          <div class="card-header">
            {{waterYearToDisplay}} Monthly Water Usage
          </div>
          <div class="card-body">
            <rio-landowner-water-use-chart [waterUsageData]="getWaterUsageForWaterYear()"
              [parcelNumbers]="parcelNumbers">
            </rio-landowner-water-use-chart>
            <p class="small">
              *Estimated water usage is based on satellite imagery and may not be accurate at the APN level.
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-4 mb-4">
      <div class="col-sm-12 col-md-12">
        <div class="card mt-4">
          <div class="card-header">
            Parcel Map
          </div>
          <div class="card-body">
            <parcel-map mapID="parcelsMapForUser" [selectedParcelIDs]="getSelectedParcelIDs()" mapHeight="500px">
            </parcel-map>
          </div>
        </div>
      </div>
    </div>
  </ng-template>
</div>