<div class="container mt-sm-4" *ngIf="activeAccount">
  <div class="float-right">
    <div class="row">
      <div class="col-md-7" style="white-space: nowrap">
        Showing data for year </div>
      <div class="col-md-5">
        <select class="form-control" [(ngModel)]="waterYearToDisplay" (change)="updateAnnualData()">
          <ng-template ngFor let-waterYear [ngForOf]="waterYears">
            <option value="{{waterYear}}">{{waterYear}}</option>
          </ng-template>
        </select>
      </div>
    </div>
  </div>
  <h2>
    Landowner Dashboard - {{getAccount()}}
  </h2>
  <app-alert-display></app-alert-display>

  <div class="row mt-4" *ngIf="parcels && parcels.length > 0 && waterUsages">
    <div class="col-sm-12 col-md-5">
      <div class="card">
        <div class="card-header">
          <div class="float-right">
            <label class="switch">
              <input type="checkbox" (change)="toggleUnitsShown()" />
              <div class="slider round">
                <span class="off">ac-ft</span>
                <span class="on">ac-ft/ac</span>
              </div>
            </label>
          </div>
          Annual Water Budget Overview
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-borderless">
              <tr>
                <th class="text-sm-left pb-0 mb-0">
                  <a style="cursor: pointer" class="collapsed"
                    (click)="showAcresManagedDetails = !showAcresManagedDetails">
                    <i *ngIf="showAcresManagedDetails else dontShowAcresManagedDetails"
                      class="fas fa-minus text-muted" style="font-size: smaller"></i>
                    <ng-template #dontShowAcresManagedDetails>
                      <i class="fas fa-plus text-muted" style="font-size: smaller"></i>
                    </ng-template>
                    Acres Managed
                  </a>
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  {{getTotalAPNAcreage() | number: '1.1-1'}} ac
                </td>
              </tr>
              <ng-container *ngIf="showAcresManagedDetails">
                <tr>
                  <td colspan="2">
                    <hr class="p-0 m-0" />
                  </td>
                </tr>
                <tr *ngFor="let parcel of parcels">
                  <th class="text-sm-right"><a
                      routerLink="/parcels/{{parcel.ParcelID}}">{{parcel.ParcelNumber}}</a></th>
                  <td class="text-sm-right">{{parcel.ParcelAreaInAcres | number: '1.1-1'}} ac
                  </td>
                </tr>
              </ng-container>
              <tr>
                <td colspan="2" class="text-left pt-0 mt-0">
                  <small>Total acres of all your managed parcels</small>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <hr style="border: 1px solid #000;" />
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0">
                  <a style="cursor: pointer" class="collapsed"
                    (click)="showAllocationDetails = !showAllocationDetails">
                    <i *ngIf="showAllocationDetails else dontShowAllocationDetails"
                      class="fas fa-minus text-muted" style="font-size: smaller"></i>
                    <ng-template #dontShowAllocationDetails>
                      <i class="fas fa-plus text-muted" style="font-size: smaller"></i>
                    </ng-template>
                    Allocation
                  </a>
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  {{getAnnualAllocation(waterYearToDisplay) | number: '1.1-1'}} {{unitsShown}}
                </td>
              </tr>
              <ng-container *ngIf="showAllocationDetails">
                <tr>
                  <td colspan="2">
                    <hr class="p-0 m-0" />
                  </td>
                </tr>
                <tr>
                  <th class="text-sm-right">
                    <a routerLink="/glossary" target="_blank" style="cursor:pointer"><i
                        class="fas fa-question-circle small"></i></a> Native Yield
                  </th>
                  <td class="text-sm-right">
                    {{getAnnualNativeYield() | number: '1.1-1'}} {{unitsShown}}
                  </td>
                </tr>
                <tr>
                  <th class="text-right">
                    <a routerLink="/glossary" target="_blank" style="cursor:pointer"><i
                        class="fas fa-question-circle small"></i></a> Project Water
                  </th>
                  <td class="text-sm-right">
                    {{getAnnualProjectWater() | number: '1.1-1'}} {{unitsShown}}
                  </td>
                </tr>
                <tr>
                  <th class="text-right">
                    <a routerLink="/glossary" target="_blank" style="cursor:pointer"><i
                        class="fas fa-question-circle small"></i></a> Stored Water
                  </th>
                  <td class="text-sm-right">
                    {{getAnnualStoredWater() | number: '1.1-1'}} {{unitsShown}}
                  </td>
                </tr>
                <tr>
                  <th class="text-right">
                    <a routerLink="/glossary" target="_blank" style="cursor:pointer"><i
                        class="fas fa-question-circle small"></i></a> Reconciliation
                  </th>
                  <td class="text-sm-right">
                    {{getAnnualReconciliation() | number: '1.1-1'}} {{unitsShown}}
                  </td>
                </tr>
              </ng-container>
              <tr>
                <td colspan="2" class="text-left pt-0 mt-0">
                  <small>Your annual allocated water budget</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0">
                  <a style="cursor: pointer" class="collapsed"
                    (click)="showPurchasedDetails = !showPurchasedDetails">
                    <i *ngIf="showPurchasedDetails else dontShowPurchasedDetails"
                      class="fas fa-minus text-muted" style="font-size: smaller"></i>
                    <ng-template #dontShowPurchasedDetails>
                      <i class="fas fa-plus text-muted" style="font-size: smaller"></i>
                    </ng-template>
                    Purchased
                  </a>
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  <span *ngIf="getPurchasedAcreFeet() as purchasedAcreFeet else noPurchasedAcreFeet">
                    {{purchasedAcreFeet | number: '1.1-1'}} {{unitsShown}}
                  </span>
                  <ng-template #noPurchasedAcreFeet>
                    <span class="systemText">-</span>
                  </ng-template>
                </td>
              </tr>
              <ng-container *ngIf="showPurchasedDetails">
                <tr>
                  <td colspan="2">
                    <hr class="p-0 m-0" />
                  </td>
                </tr>
                <tr *ngFor="let waterTransfer of getPurchasedWaterTransfersForWaterYear()">
                  <th class="text-sm-right"><span *ngIf="isWaterTransferPending(waterTransfer)">*</span><a
                      routerLink="/trades/{{waterTransfer.TradeNumber}}">{{waterTransfer.TradeNumber}} ({{waterTransfer.TransferDate | date:"MM/dd"}})</a>
                  </th>
                  <td class="text-sm-right">{{getResultInUnitsShown(waterTransfer.AcreFeetTransferred) | number: '1.1-1'}} {{unitsShown}}
                  </td>
                </tr>
              </ng-container>
              <tr>
                <td colspan="2" class="text-left pt-0 mt-0">
                  <small>Water supply you have purchased this year</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0">
                  <a style="cursor: pointer" class="collapsed" (click)="showSoldDetails = !showSoldDetails">
                    <i *ngIf="showSoldDetails else dontShowSoldDetails" class="fas fa-minus text-muted" style="font-size: smaller"></i>
                    <ng-template #dontShowSoldDetails>
                      <i class="fas fa-plus text-muted" style="font-size: smaller"></i>
                    </ng-template>
                  </a>
                  Sold
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  <span *ngIf="getSoldAcreFeet() as soldAcreFeet else noSoldAcreFeet">
                    {{soldAcreFeet | number: '1.1-1'}} {{unitsShown}}
                  </span>
                  <ng-template #noSoldAcreFeet>
                    <span class="systemText">-</span>
                  </ng-template>
                </td>
              </tr>
              <ng-container *ngIf="showSoldDetails">
                <tr>
                  <td colspan="2">
                    <hr class="p-0 m-0" />
                  </td>
                </tr>
                <tr *ngFor="let waterTransfer of getSoldWaterTransfersForWaterYear()">
                  <th class="text-sm-right"><span *ngIf="isWaterTransferPending(waterTransfer)">*</span><a
                      routerLink="/trades/{{waterTransfer.TradeNumber}}">{{waterTransfer.TradeNumber}} ({{waterTransfer.TransferDate | date:"MM/dd"}})</a>
                  </th>
                  <td class="text-sm-right">{{getResultInUnitsShown(waterTransfer.AcreFeetTransferred) | number: '1.1-1'}} {{unitsShown}}
                  </td>
                </tr>
              </ng-container>
              <tr>
                <td colspan="2" class="text-left pt-0 mt-0">
                  <small>Water supply you have sold this year</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0">
                  Total Supply
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  <span>{{getTotalSupply() | number: '1.1-1'}} {{unitsShown}}</span>
                </td>
              </tr>
              <tr>
                <td colspan="2" class="text-left pt-0 mt-0">
                  <small>Allocation + Purchased – Sold</small>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <small class="systemText" *ngIf="showSoldDetails || showPurchasedDetails">* denotes a pending
                    transaction</small>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <hr style="border: 1px solid #000;" />
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0">
                  Usage to Date
                </th>
                <td class="text-sm-right pb-0 mb-0">
                  <span *ngIf="getWaterUsageToDate() as waterUsageToDate else noWaterUsage">
                    {{waterUsageToDate | number: '1.1-1'}} {{unitsShown}}
                  </span>
                  <ng-template #noWaterUsage>
                    <span class="systemText">Not available</span>
                  </ng-template>
                </td>
              </tr>
              <tr>
                <td colspan="2" class="text-left pt-0 mt-0">
                  <small>Total usage this year as measured by OpenET</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0">Current Available</th>
                <td class="text-sm-right pb-0 mb-0">
                  {{getCurrentAvailableWater() | number: '1.1-1'}} {{unitsShown}}
                </td>
              </tr>
              <tr>
                <td colspan="2" class="text-left pt-0 mt-0">
                  <small>Allocation + Purchased – Sold – Usage to Date</small>
                </td>
              </tr>
              <tr>
                <th class="text-sm-left pb-0 mb-0">Average Annual Usage</th>
                <td class="text-sm-right pb-0 mb-0">
                  {{getResultInUnitsShown(historicAverageAnnualUsage) | number: '1.1-1'}} {{unitsShown}}
                </td>
              </tr>
              <tr>
                <td colspan="2" class="text-left pt-0 mt-0">
                  <small>Average annual usage from all years of OpenET data</small>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-12 col-md-7">
      <div class="row">
        <div class="col-sm-12">
          <div class="card">
            <div class="card-header">
              {{waterYearToDisplay}} Allocation and Usage
            </div>
            <div class="card-body" *ngIf="annualAllocationChartData && waterUsageOverview">
              <rio-landowner-water-allocation-chart [annualAllocationSeries]="getAnnualAllocationSeries()"
                [yDomain]="allocationChartRange" [historicCumulativeWaterUsage]="historicCumulativeWaterUsage"
                [currentCumulativeWaterUsage]="getCumulativeWaterUsageForWaterYear()">
              </rio-landowner-water-allocation-chart>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-4">
        <div class="col-sm-12">
          <div class="card">
            <div class="card-header">
              {{waterYearToDisplay}} Water Usage by Parcel
            </div>
            <div class="card-body" *ngIf="waterUsageChartData">
              <rio-landowner-water-use-chart [waterUsageData]="getWaterUsageForWaterYear()"
                [parcelNumbers]="parcelNumbers">
              </rio-landowner-water-use-chart>
              <p class="small">
                *Estimated water usage is based on satellite imagery and may not be accurate at the APN level.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-4" *ngIf="trades">
    <div class="col-sm-12">
      <div class="card">
        <div class="card-header">
          <div class="float-right">
            <label class="switch">
              <input type="checkbox" (change)="toggleTradeStatusShown()" />
              <div class="slider round">
                <span class="off">Active</span>
                <span class="on">All</span>
              </div>
            </label>
          </div>
          Trade Activity
        </div>
        <div class="card-body table-responsive" style="max-height: 300px; overflow-y:scroll">
          <ng-template #noTradesForWaterYear>
            <p>{{getNoTradesMessage()}}</p>
          </ng-template>
          <table class="table table-condensed table-striped"
            *ngIf="getTradesForWaterYear().length > 0 else noTradesForWaterYear">
            <thead>
              <tr>
                <th>Trade</th>
                <th>Date</th>
                <th>Status</th>
                <th>Description</th>
                <th style="text-align: right">Price</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let trade of getTradesForWaterYear()">
                <td style="border: 0 none; white-space: nowrap"><a
                    routerLink="/trades/{{trade.TradeNumber}}">{{ trade.TradeNumber }}</a></td>
                <td style="border: 0 none">{{ trade.OfferDate | date: "MM/dd" }}</td>
                <td style="border: 0 none; white-space: nowrap">
                  <a routerLink="/register-transfer/{{trade.WaterTransferID}}"
                    *ngIf="trade.WaterTransferID && !isTradeRegisteredByUser(trade) && !isTradeCanceled(trade)">
                    Awaiting Registration
                  </a>
                  <span *ngIf="trade.WaterTransferID && isTradeCanceled(trade)">Canceled</span>
                  <span
                    *ngIf="trade.WaterTransferID && isTradeRegisteredByUser(trade) && !isTradeRegisteredByBothParties(trade)">You
                    have already registered this transfer.<br />The other party must still register<br />before the
                    water
                    is transferred</span>
                  <span
                    *ngIf="!trade.WaterTransferID || isTradeRegisteredByBothParties(trade)">{{getTradeStatus(trade)}}</span>
                </td>
                <td style="border: 0 none">{{getTradeDescription(trade)}}</td>
                <td style="border: 0 none; white-space: nowrap; text-align: right">
                  {{ trade.Price * trade.Quantity | currency: "USD" }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card mt-2">
        <div class="card-header">
          <div class="float-right">
            <label class="switch">
              <input type="checkbox" (change)="togglePostingStatusShown()" />
              <div class="slider round">
                <span class="off">Active</span>
                <span class="on">All</span>
              </div>
            </label>
          </div>
          Postings
        </div>
        <div class="card-body table-responsive" style="max-height: 200px; overflow-y:scroll">
          <ng-template #noPostingsForWaterYear>
            <p>{{getNoPostingsMessage()}}</p>
          </ng-template>
          <table class="table table-condensed table-striped"
            *ngIf="getPostingsForWaterYear().length > 0 else noPostingsForWaterYear">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Status</th>
                <th>Initial Quantity</th>
                <th>Current Quantity</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let posting of getPostingsForWaterYear()">
                <td style="white-space: nowrap"><a
                    routerLink="/postings/{{posting.PostingID}}">{{ posting.PostingDate | date:"MM/dd" }}</a>
                </td>
                <td style="white-space: nowrap">{{ posting.PostingType.PostingTypeDisplayName }}
                </td>
                <td style="white-space: nowrap">{{ posting.PostingStatus.PostingStatusDisplayName }}
                </td>
                <td>{{ posting.Quantity | number: "1.0" }} ac-ft</td>
                <td>{{ posting.AvailableQuantity | number: "1.0" }} ac-ft</td>
                <td style="white-space: nowrap">{{ posting.Price | currency: "USD" }} per ac-ft</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-4 mb-4" *ngIf="parcels && parcels.length > 0">
    <div class="col-sm-12 col-md-12">
      <div class="card mt-4">
        <div class="card-header">
          Parcel Map
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-sm-12 col-md-10" *ngIf="parcels">
              <parcel-map mapID="parcelsMapForUser" [selectedParcelIDs]="getSelectedParcelIDs()" mapHeight="500px">
              </parcel-map>
            </div>
            <div class="col-sm-12 col-md-2">
              <ul>
                <li *ngFor="let parcel of parcels"><a
                    routerLink="/parcels/{{parcel.ParcelID}}">{{parcel.ParcelNumber}}</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>